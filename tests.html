<!DOCTYPE html>
<html>
<head>
  <title>Runloop Workshop Exercise C</title>
  <meta name="description" content="guide: testing-models-2" />
  <meta charset="utf-8">
  <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.14.0.css">
  <script src='http://code.jquery.com/jquery.js'></script>
  <script src="http://code.jquery.com/qunit/qunit-1.14.0.js"></script>
  <script src='http://underscorejs.org/underscore.js'></script>
  <script src='http://backbonejs.org/backbone.js'></script>
  <script src='./runloop.js'></script>
</head>
<body>
  <div id="qunit"></div>
  <div id="ember-testing"></div>

<script>
module("Has tests");

test("has Runloop", function(){
  ok(Runloop, "Runloop exists");
});

test("Runloop.begin; schedule; end", function(){
  var itRan = false;

  Runloop.begin();

  Runloop.schedule(null, function(){
    itRan = true;
  });

  ok(!itRan, 'scheduling defers execution');

  Runloop.end();

  ok(itRan, 'scheduled task is run');
});

test("Runloop.schedule outside of runloop throws", function(){
  throws(function(){
    Runloop.schedule(null, function(){
      //
    });
  }, /without a runloop/,
     "includes an error message saying 'without a runloop'");
});

test("Runloop.schedule is applied with context", function(){
  var context = {itRan: false};

  Runloop.begin();
  Runloop.schedule(context, function(){
    this.itRan = true;
  });
  Runloop.end();

  ok(context.itRan, 'it ran with context');
});

test("Runloop.schedule'd tasks are run in correct order", function(){
  var itRans = [];

  Runloop.begin();

  Runloop.schedule(null, function(){
    itRans.push("first");
  });

  Runloop.schedule(null, function(){
    itRans.push("second");
  });

  Runloop.schedule(null, function(){
    itRans.push("third");
  });

  Runloop.end();

  deepEqual(itRans, ["first","second","third"],
            "scheduled tasks run in order");
});

module("Runloop part 4");

test("Runloop.run calls the callback", function(){
  var itRan = false;
  Runloop.run(null, function(){
    itRan = true;
  });

  ok(itRan, 'Runloop.run executes the passed function');
});

test("Runloop.run executes with a passed context", function(){
  var context = {itRan: false};

  Runloop.run(context, function(){
    this.itRan = true;
  });

  ok(context.itRan, 'Runloop executes the passed function with the passed context');
});

test("Runloop.schedule inside Runloop.run", function(){
  var outer = false, inner = false;

  Runloop.run(null, function(){
    outer = true;
    Runloop.schedule(null, function(){
      inner = true;
    });
  });

  ok(outer, '.run callback is executed');
  ok(inner, 'scheduled task ran');
});

test("Runloop.schedule into 'render' happens after 'actions'", function(){
  var tasks = [];

  Runloop.run(null, function(){

    Runloop.schedule(null, function(){
      tasks.push('second');
    }, 'render');

    Runloop.schedule(null, function(){
      tasks.push('first');
    }, 'actions');
  });

  deepEqual(tasks, ['first','second'], 'actions queue flushes before render queue');
});

test("Runloop.schedule into nonexistent queue throws", function(){
  expect(1);

  Runloop.run(null, function(){
    throws(function(){
      Runloop.schedule(null, function(){
        //
      }, 'nonexistentqueue');
    }, /cannot schedule into a nonexistent queue/,
       'cannot schedule into nonexistent queue');
  });
});




</script>
</body>
</html>

